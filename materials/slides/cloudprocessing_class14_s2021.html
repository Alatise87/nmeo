<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Ground Sensors</title>
    <meta charset="utf-8" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/lucy.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/middlebury-fonts.css" rel="stylesheet" />
    <script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
    <script src="libs/jquery-1.12.4/jquery.min.js"></script>
    <link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
    <script src="libs/leaflet-1.3.1/leaflet.js"></script>
    <link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
    <script src="libs/proj4-2.6.2/proj4.min.js"></script>
    <script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
    <link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
    <script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
    <script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
    <script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script>
    <link rel="stylesheet" href="themes/class8-theme.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Ground Sensors
## New Methods in Earth Observation
### Class 16

---







```{=html}
&lt;div id="htmlwidget-fe1af92d1e2a7b5dc3c9" style="width:504px;height:504px;" class="leaflet html-widget"&gt;&lt;/div&gt;
&lt;script type="application/json" data-for="htmlwidget-fe1af92d1e2a7b5dc3c9"&gt;{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addProviderTiles","args":["Esri.WorldImagery",null,null,{"errorTileUrl":"","noWrap":false,"detectRetina":false}]},{"method":"addTiles","args":["https://tiles.rasterfoundry.com/7a4b4cb3-fe35-46c9-9896-6e98eec46665/{z}/{x}/{y}/?tag=1538578249206&amp;mapToken=8ab506f7-9ef0-46f2-afe6-db5ec1c9e9e4",null,"planet6/12",{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false}]},{"method":"addTiles","args":["https://tiles.rasterfoundry.com/e319cae9-4093-40b1-8961-033fa6753ec6/{z}/{x}/{y}/?tag=1538580563314&amp;mapToken=3438e35f-07d3-4644-a52a-aea0a4bf7aec",null,"planet6/16",{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false}]},{"method":"addMarkers","args":[[42.120884,42.121805,42.122951],[-71.806965,-71.806478,-71.805491],null,null,null,{"interactive":true,"draggable":false,"keyboard":true,"title":"","alt":"","zIndexOffset":0,"opacity":1,"riseOnHover":false,"riseOffset":250},null,null,null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addLayersControl","args":[[],["sequoia","planet6/16"],{"collapsed":false,"autoZIndex":false,"position":"topright"}]}],"setView":[[42.121805,-71.806965],15,[]],"limits":{"lat":[42.120884,42.122951],"lng":[-71.806965,-71.805491]}},"evals":[],"jsHooks":[]}&lt;/script&gt;
```



## [Arable Labs](https://www.arable.com/)
### [Mark-2 Sensor](https://www.arable.com/mark2)
### [Water Issues](https://www.youtube.com/watch?v=BG4FaHkhkho)

---

## Main Arable data
- NDVI 
- Individual band reflectance 
- Precipitation
- Temperature
- Shortwave downwelling radiation (important for crop growth)

---
## Arable API
- Data sets are available in different formats (e.g. "daily", "hourly")
- Currently uses a Python API
- Follow instructions on [Github repo](https://github.com/arable-examples/arable-python-lib)


---
## Let's use the Client

There are a couple of things to note: 

##### 1. We have three devices--their IDs are A000667, A000671,  and A000680

We are going to start by selecting daily variables for device A000680 for the month of June

---

```r
## load libraries
library(dplyr)
library(data.table)
library(ggplot2)
library(gridExtra)
library(lubridate)
library(raster)
```


---

```r
# getwd()
dev1 &lt;- read.csv("/Users/michaelcecil/Rprojects/geog287387_s/materials/code/python/A000680_daily.csv",
                 stringsAsFactors = F)
# a little cleaning
dev1 &lt;- data.table(dev1)
dev1[is.na(precip), precip := 0]  # set NA precip to 0
dev1$date &lt;- as_date(dev1$time)
dev1 &lt;- dev1 %&gt;% filter( (date &gt;= as_date("2018-06-01")) &amp; 
                           (date &lt;= as_date("2018-09-30") ))
```


---
We've processed the data, now let's look at it

```r
dat &lt;- dev1  # change this when you change devices
mytheme &lt;- function() theme(axis.title.x = element_blank())
p1 &lt;- ggplot(dat) + geom_line(aes(x = date, y = precip), col = "blue") + mytheme()
p2 &lt;- ggplot(dat) + geom_line(aes(date, ndvi), col = "green3") + mytheme()
p3 &lt;- ggplot(dat) + geom_line(aes(date, meant), col = "purple") + mytheme()
p4 &lt;- ggplot(dat) + geom_line(aes(date, swdw), col = "orange") + mytheme()
grid.arrange(p1, p2, p3, p4, ncol = 2)
```

&lt;img src="cloudprocessing_class14_s2021_files/figure-html/unnamed-chunk-4-1.png" style="display: block; margin: auto;" /&gt;

---

## Assignment

**Part 1: Reuse the code above to do the following:**

- Change the date range to June 1 to September 15
- Do that for each of the three devices
  - Change the `device` argument between "A000667", "A000671", "A000680"
  - direct the output to `dev1`, `dev2`, `dev3`
- Reuse the plot code for `dev1`, `dev2`, `dev3`
  - replace `dev1` with `dev2` or `dev3` in the `dat` argument, e.g. `dat &lt;- dev2`
- This means you will have three blocks of processing code, for `dev1`, `dev2`, `dev3`, and three blocks of plotting code for `dev1`, `dev2`, `dev3`
---


```r
# getwd()

## dev1 is A000680
## dev2 is A000667
## dev3 is A000671
dev2 &lt;- read.csv("/Users/michaelcecil/Rprojects/geog287387_s/materials/code/python/A000667_daily.csv",
                 stringsAsFactors = F)
# a little cleaning
dev2 &lt;- data.table(dev2)
dev2[is.na(precip), precip := 0]  # set NA precip to 0
dev2$date &lt;- as_date(dev2$time)
dev2 &lt;- dev2 %&gt;% filter( (date &gt;= as_date("2018-06-01")) &amp; 
                           (date &lt;= as_date("2018-09-30") ))



dat &lt;- dev2  # change this when you change devices
mytheme &lt;- function() theme(axis.title.x = element_blank())
p1 &lt;- ggplot(dat) + geom_line(aes(x = date, y = precip), col = "blue") + mytheme()
p2 &lt;- ggplot(dat) + geom_line(aes(date, ndvi), col = "green3") + mytheme()
p3 &lt;- ggplot(dat) + geom_line(aes(date, meant), col = "purple") + mytheme()
p4 &lt;- ggplot(dat) + geom_line(aes(date, swdw), col = "orange") + mytheme()
grid.arrange(p1, p2, p3, p4, ncol = 2)
```

```
## Warning: Removed 1 row(s) containing missing values (geom_path).

## Warning: Removed 1 row(s) containing missing values (geom_path).

## Warning: Removed 1 row(s) containing missing values (geom_path).
```

![](cloudprocessing_class14_s2021_files/figure-html/unnamed-chunk-5-1.png)&lt;!-- --&gt;


---

```r
# getwd()

## dev1 is A000680
## dev2 is A000667
## dev3 is A000671
dev3 &lt;- read.csv("/Users/michaelcecil/Rprojects/geog287387_s/materials/code/python/A000671_daily.csv",
                 stringsAsFactors = F)
# a little cleaning
dev3 &lt;- data.table(dev3)
dev3[is.na(precip), precip := 0]  # set NA precip to 0
dev3$date &lt;- as_date(dev3$time)
dev3 &lt;- dev3 %&gt;% filter( (date &gt;= as_date("2018-06-01")) &amp; 
                           (date &lt;= as_date("2018-09-30") ))



dat &lt;- dev3  # change this when you change devices
mytheme &lt;- function() theme(axis.title.x = element_blank())
p1 &lt;- ggplot(dat) + geom_line(aes(x = date, y = precip), col = "blue") + mytheme()
p2 &lt;- ggplot(dat) + geom_line(aes(date, ndvi), col = "green3") + mytheme()
p3 &lt;- ggplot(dat) + geom_line(aes(date, meant), col = "purple") + mytheme()
p4 &lt;- ggplot(dat) + geom_line(aes(date, swdw), col = "orange") + mytheme()
grid.arrange(p1, p2, p3, p4, ncol = 2)
```

```
## Warning: Removed 2 row(s) containing missing values (geom_path).
```

![](cloudprocessing_class14_s2021_files/figure-html/unnamed-chunk-6-1.png)&lt;!-- --&gt;


```






---
**Part 2: Download CHIRPs daily rainfall data for Sutton**

Using this [code](https://code.earthengine.google.com/7b5f93a1c71f25619d6414c71ce671a1)

- Change the dates for download to start on 6/1/2018 and end on 9/30/2018
- Export it to your Google Drive account
- Study the code so that you understand how it works
    - Be ready to explain how you would change it to download more than one year's worth of data. 

---

```r
devs &lt;- rbind(dev1, dev2, dev3)  # joint them into a single dataset
##devs &lt;- dev1
dev_coords &lt;- devs[, list("lat" = mean(lat, na.rm = TRUE), 
                          "long" = mean(long, na.rm = TRUE)), by = device]
```
---


### Bring in the rainfall data

Find the CHIRPs data you downloaded from Google Drive. You need to put your file path into that. 

We are going to quickly look at that dataset, and where the pods lie in relation to it. 

```r
chirpsrf &lt;- brick("/Users/michaelcecil/Downloads/chirps_20180601.tif")
rfsum &lt;- calc(chirpsrf, sum)  # sum the rainfall

# plot it
plot(rfsum)
points(dev_coords$long, dev_coords$lat, pch = "+")
```




---

Let's try that with leafet instead, making our own little mini-GIS

```r
m &lt;- leaflet() %&gt;% addProviderTiles("Esri.WorldImagery") %&gt;% 
  setView(dev_coords[1, long], dev_coords[1, lat], zoom = 11) %&gt;%
  addTiles(planet1, group = "planet6/12") %&gt;% 
  addTiles(sequoia, group = "sequoia") %&gt;% 
  addRasterImage(rfsum, group = "CHIRPS") %&gt;% 
  addCircleMarkers(lng = dev_coords$long, lat = dev_coords$lat, radius = 1, 
                   col = "red", opacity = 1, group = "Pods") %&gt;% 
  addLayersControl(overlayGroups = c( "CHIRPS", "Pods"),
                   options = layersControlOptions(collapsed = FALSE, 
                                                  autoZIndex = FALSE))
m
```






---

Now we are going to use the pod coordinates to `extract` (a function from the raster package) data from CHIRPs and the UAS data. Let's start with CHIRPs. Since the pods all sit in one CHIRPs pixel, we only need to use one point to extract the data. 


```r
rfvals &lt;- extract(chirpsrf, dev_coords[1, 3:2])
```

That gives us a data.frame with one row, with all CHIRPs values from 5/1 to 8/31. We need to do some extra work to: 

1) convert the data to a vector 

2) reduce it to just the dates for which we have pod data.


```r
rfvals &lt;- unname(rfvals[1, ])  # remove column names, convert to vector

# create date, using lubridate library
chirps_start_date &lt;- "2018-06-01"
chirps_end_date &lt;- "2018-09-30"
dts &lt;- seq(ymd(chirps_start_date), ymd(chirps_end_date), by =  '1 day')
start_date &lt;- which(dts %in% as_date("2018-06-08"))  # starting date for pods
end_date &lt;- length(rfvals)  # last date in CHIRPs
rfvals_forpods &lt;- rfvals[start_date:end_date] # subset the CHIRPs to pod dates
dts_forpods &lt;- dts[start_date:end_date]  # extract the dates from dts
rfvals_dts &lt;- data.table(dts_forpods, rfvals_forpods)  # combine into data.table
setnames(rfvals_dts, c("date", "chirpsrf")) # rename the columns
```
---
Now that we have our CHIRPs data extracted, we join it back into our pod data, using a function called `merge`. We are going to merge by the date variable, but we need to make a new date variable in `devs` first


```r
# combine with devs
#devs[, date := as_date(datetime)]  # make new date column
devs2 &lt;- merge(devs, rfvals_dts, by = "date", all.x = TRUE)  # merge data
```

Let's look at the results now, comparing how well the pod rainfall aligns with the CHIRPs rainfall


```r
# ggplot(devs2) + geom_line(aes(date, precip, colour = device))
ggplot(devs2) + geom_point(aes(precip, chirpsrf, colour = device)) + coord_fixed()
```
---
So that's not great.  Why might that be? 

How about we see how it looks at weekly time steps?

```r
devs2[, week := week(date)]  # create a variable indicating week of year
weeklypre &lt;- devs2[, list("podpre" = sum(precip), "chirppre" = sum(chirpsrf)), 
      by = list(device, week)]  # sum rainfall by device and week

ggplot(weeklypre) + geom_point(aes(podpre, chirppre, colour = device)) + coord_fixed() 
```

Now, that's starting to look like a bit better. So what does that tell us?

---
## For next class

- Work on Assignment 3
- (demo) Run the precip comparison for 2020
- Read [Antony et al 2020](http://dx.doi.org/10.3390/su12093750)
- Watch [delivering soil intelligence](https://www.youtube.com/watch?v=gAapCKrrO18)
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
