---
title: "Droning On 3"
subtitle: "New Methods in Earth Observation"
author: "Lyndon Estes"
date: "9/4/2018"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "lucy", "middlebury-fonts", "class5-theme.css"]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Analyzing Drone Orthomosaics

#### - eMotion/flight correction
#### - Examine PIX4D outputs
#### - Exercises using R, gdal, and leaflet to examine the drone orthomosaics we created for homework. 
&nbsp;&nbsp;+ Requires working R, Rstudio, gdal installs, and changing a few parameters 

&nbsp;&nbsp;+ If that fails, ArcGIS/Terrset/QGIS as a substitute

##### - Run the following code to start, in open Rstudio session

```{r, eval = FALSE}
install.packages("gdalUtils")
install.packages("raster")
```

This provides necessary libraries for our analyses

---
class: center, middle
# eMotion and PIX4D outputs

---

### Open Up eMotion3
#### Set up new mission over Whittier
#### Run simulation
### PIX4D project
#### Quality Reports
#### Ray clouds

---
class: center, middle
# Examining Our Orthomosaic Results

---
## Starting with Pre-processing

### Exercise 1 

#### - An initial look at August 24th orthomosaic reflectance for permutation 1, with reflectance targets and PPK correction.  

##### - Run this code

Replace the path in `p` with the directory string for the project directory on your computer.  After replacing this, run this chunk of code
```{r, eval = FALSE}
## Replace this here with the path to your project directory!
p <- "~/Dropbox/data/imagery/uas/pix4d/whittier_demo_24August2018"

library(raster)
fp <- file.path(p, "4_index/reflectance/")
img_nms <- dir(fp, pattern = "transparent*.*.tif$", full.names = TRUE)
s <- stack(lapply(img_nms[c(2, 4, 1)], raster))
plotRGB(s, scale = 1, zlim = c(0, 1))
```

```{r, echo = FALSE, eval=FALSE}
png("materials/slides/figures/05/aug24_1.png", height = 600, width = 600)
par(mar = c(0, 0, 0, 0), bg = "transparent")
plotRGB(s, scale = 1, colNA = "transparent", zlim = c(0, 1), bgalpha = 0)
dev.off()
```
You should see something that looks like this

---

![](figures/05/aug24_1.png)
---

Now let's make a multi-band stack of the images, drawing on a customized function that relies on gdal

First, you have to source the companion script, provided via Slack, so run this, after entering the right path

```{r, eval = FALSE}
p <- "materials/scripts/class5.R"
source(p)
```

Now, we want to use a function in that script we just sourced. The function takes 3 arguments: 

&nbsp;&nbsp;+ `nms`, the paths to the reflectance bands. We want just NIR, Red, Green.

&nbsp;&nbsp;+ `out_dir`, the path to the output directory you select

&nbsp;&nbsp;+ `out_name`, the root base name (no extension) for the stacked geotiff


```{r, eval = FALSE}
# set your variables first
nms <- img_nms[c(2, 4, 1)]  # use this
out_dir <- "materials/data/05"  # change this as desired
out_name <- "aug24_ngb"  # recommended default

# runs the function and then plots it
b1 <- multi_band_stack(nms = nms, out_dir = out_dir, out_name = out_name)
plotRGB(b1, scale = 1, colNA = "transparent", zlim = c(0, 1))
```

---

Okay, let's convert the other 4 images to multi-band stacks

August 24, PPK, no reflectance target
```{r, eval = FALSE}
p <- "~/Dropbox/data/imagery/uas/pix4d/whittier_demo_24August2018_noreftarget/"
fp <- file.path(p, "4_index/reflectance/")
img_nms <- dir(fp, pattern = "transparent*.*.tif$", full.names = TRUE)

nms <- img_nms[c(2, 4, 1)]
out_dir <- "materials/data/05"
out_name <- "aug24_ngb_noreftarget"
b2 <- multi_band_stack(nms = nms, out_dir = out_dir, out_name = out_name)
plotRGB(b2, scale = 1, colNA = "transparent", zlim = c(0, 1))
```

August 24, PPK, no reflectance target
```{r, eval = FALSE}
p <- "~/Dropbox/data/imagery/uas/pix4d/whittier_demo_24August2018_noppk"
fp <- file.path(p, "4_index/reflectance/")
img_nms <- dir(fp, pattern = "transparent*.*.tif$", full.names = TRUE)

nms <- img_nms[c(2, 4, 1)]
out_name <- "aug24_ngb_noppk"
b3 <- multi_band_stack(nms = nms, out_dir = out_dir, out_name = out_name)
plotRGB(b3, scale = 1, colNA = "transparent", zlim = c(0, 1))
```

---

August 31, PPK, no reflectance target
```{r, eval = FALSE}
p <- "~/Dropbox/data/imagery/uas/pix4d/whittier_demo_31August2018_noreftarget/"
fp <- file.path(p, "4_index/reflectance/")
img_nms <- dir(fp, pattern = "transparent*.*.tif$", full.names = TRUE)

nms <- img_nms[c(2, 4, 1)]
out_name <- "aug31_ngb_noreftarget"
b4 <-  multi_band_stack(nms = nms, out_dir = out_dir, out_name = out_name)
plotRGB(b4, scale = 1, colNA = "transparent", zlim = c(0, 1))
```

```{r, echo = FALSE, eval = FALSE}
ext <- apply(do.call(rbind, lapply(list(b1, b2, b3), sf::st_bbox)), 2, min)
ext <- as(extent(ext[c(1, 3, 2, 4)]), "SpatialPolygons")
proj4string(ext) <- proj4string(b1)
ext <- spTransform(ext, "+proj=longlat +datum=WGS84 +no_defs")
```

---

Now we are going to process the different images so that we can perform bandmath on them. 

This entails using another custom function that calls `gdalwarp`:

&nbsp;&nbsp;+ reprojects to WGS84

&nbsp;&nbsp;+ aligns images to same extent

This is the extent we are using, so run this

```{r, eval = FALSE}
ext <- c(-71.8101, 42.1193, -71.8041, 42.1242)
```

And now let's process the first image stack

```{r, eval = FALSE}
b1a <- img_align(img = b1@file@name, out_dir = "materials/data/05", 
                 out_name = "aug24_ngb_cog", ext = ext)
```

And have a look at it

```{r, eval = FALSE}
plotRGB(b1a, scale = 1, colNA = "transparent", zlim = c(0, 1))
```

---

Let's do the rest now

```{r, eval = FALSE}
b2a <- img_align(img = b2@file@name, out_dir = "materials/data/05", 
                 out_name = "aug24_ngb_noreftarget_cog", ext = ext)
b3a <- img_align(img = b3@file@name, out_dir = "materials/data/05", 
                 out_name = "aug24_ngb_noppk_cog", ext = ext)
b4a <- img_align(img = b4@file@name, out_dir = "materials/data/05", 
                 out_name = "aug31_ngb_noreftarget_cog", ext = ext)
```

---
class: center, middle
# Comparisons

---

## Reflectance calibration strategy

How much difference? Let's visualize

```{r, eval = FALSE}
ref_diff <- b1a - b2a  # subtract no ref target from ref target

# plot the difference maps, per band
nms <- c("NIR", "Red", "Green")
plot(ref_diff, main = nms, axes = FALSE, zlim = c(-0.5, 0.5))  
```

---
How much difference in stats?

```{r, eval = FALSE}
stats <- cellStats(ref_diff, summary)
colnames(stats) <- nms
round(stats, 3)
```

---

## PPK versus not

```{r, eval = FALSE}
ref_diff <- b2a - b3a  # subtract no ref target from ref target

# plot the difference maps, per band
nms <- c("NIR", "Red", "Green")
plot(ref_diff, main = nms, axes = FALSE, zlim = c(-0.5, 0.5))

stats <- cellStats(ref_diff, summary)
colnames(stats) <- nms
round(stats, 3)
```

---

## Two different dates

```{r, eval = FALSE}
ref_diff <- b2a - b4a  # subtract no ref target from ref target

# plot the difference maps, per band
nms <- c("NIR", "Red", "Green")
plot(ref_diff, main = nms, axes = FALSE, zlim = c(-0.5, 0.5))

stats <- cellStats(ref_diff, summary)
colnames(stats) <- nms
round(stats, 3)
```

## Effective Resolution

How much shift between PPK strategies?

```{r, eval = FALSE}
ext <- c(-71.80800, 42.120790, -71.807950, 42.121566)
plot(as(extent(ext[c(1, 3, 2, 4)]), "SpatialPolygons"), lty = 0)
plotRGB(b2a, scale = 1, colNA = "transparent", zlim = c(0, 1), add = TRUE)
plotRGB(b3a, scale = 1, colNA = "transparent", zlim = c(0, 1), add = TRUE)

```