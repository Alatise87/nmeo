---
title: "Class 7 practice - Planetscope"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Instructions
Execute all chunks separately. i.e. ctrl-shift-enter while the cursor is in the chunk. 

Make sure this returns your file path ending in "geog287387/". If it doesn't, uncomment out line 19 and edit it match your path to the geog287387 project.  
```{r, eval=FALSE}
bpath <- paste0(getwd(), "/")
# bpath <- "D:/Users/<your_user_name>/Documents/geog287387/"
bpath
```


## Packages
```{r, eval=FALSE}
# setwd("..")
library(gdalUtils)
library(raster)
script_path <- paste0(bpath, "materials/code/R/uas_image_functions.R")
source(script_path)
```

## Paths
Set up paths to downloaded Planetscope imagery, and create output directory for adjusting images. You can make notes here. 
```{r, eval=FALSE}
img_path <- paste0(bpath, "materials/data/whittier/planet_data")
out_dir <- paste0(bpath, "materials/data/whittier/output")

if(!dir.exists(out_dir)) dir.create(out_dir)

planet_imgs <- dir(img_path, pattern = "SR_clip.tif", full.names = FALSE)

library(stringr)
## rename files
## this will remove most dates with duplicate images
for (old_file_name in planet_imgs){
  file_name_character_start <- str_locate(old_file_name, "2020-")[1]
  new_file_name <- substr(old_file_name, file_name_character_start, 1000)
  file.copy(paste0(img_path, "/", old_file_name), paste0(out_dir, "/", new_file_name))
}

## get vector of new image paths
planet_imgs <- dir(out_dir, pattern = "SR_clip.tif", full.names = TRUE)



```

## Read in image details

Testing read in and plot of one image
```{r, eval=FALSE}
b1 <- brick(planet_imgs[[7]])

# Use gdal to reproject images to EPSG4326 and to a defined extent
ext <- c(-71.8101, 42.1193, -71.8041, 42.1242)
out1 <- substr(basename(planet_imgs[[1]]), 1, 1000)
prj <- proj4string(b1)
planet1 <- img_align(img = b1@file@name, res = 3 / 100000, out_dir = out_dir, 
                     out_name = out1, ext = ext)
plotRGB(planet1[[c(4, 3, 2)]], scale = 10000, zlim = c(0,10000), stretch = "lin")
```

## Read in and process all PlanetScope images
```{r, eval=FALSE}
ext <- c(-71.8101, 42.1193, -71.8041, 42.1242)

plist <- lapply(1:length(planet_imgs), function(x) {
  nm <- planet_imgs[[x]]
  b <- brick(nm)
  out <- paste0(substr(basename(nm), 1, 1000), "_", x)
  prj <- proj4string(b)
  planet1 <- img_align(img = b@file@name, res = 3 / 100000, out_dir = out_dir,                        out_name = out, ext = ext)
})
```


##############

##UDM work

## let's first rename the UDM2 (usable data mask) files, like we did for the SR files.
## Details on UDM2 bands can be found here https://developers.planet.com/docs/data/udm-2/
```{r, eval=FALSE}


# code here
bpath <- paste0(getwd(), "/")
# bpath <- "D:/Users/<your_user_name>/Documents/geog287387/"
bpath
img_path <- paste0(bpath, "materials/data/whittier/planet_data")
out_dir <- paste0(bpath, "materials/data/whittier/output")

if(!dir.exists(out_dir)) dir.create(out_dir)

planet_imgs_udm <- dir(img_path, pattern = "udm2_clip.tif", full.names = FALSE)

library(stringr)
## rename files
## this will remove most dates with duplicate images
for (old_file_name in planet_imgs_udm){
  file_name_character_start <- str_locate(old_file_name, "2020-")[1]
  new_file_name <- substr(old_file_name, file_name_character_start, 1000)
  file.copy(paste0(img_path, "/", old_file_name), paste0(out_dir, "/", new_file_name))
}

## get vector of new UDM paths
planet_imgs_udm <- dir(out_dir, pattern = "udm2_clip.tif", full.names = TRUE)

```

# Read in image details

Testing read in and plot of UDM2 image. We are going to plot band 1 of UDM 2 representing clear/not-clear (1 is clear)
```{r, eval=FALSE}
img_index <- 7 ## 7th of 28 images, for July 5th

par(mfrow = c(1, 2), mar = rep(1, 2))

b1_udm <- brick(planet_imgs_udm[[img_index]]) ## take 7th image, representing July 05, 2020

# Use gdal to reproject images to EPSG4326 and to a defined extent
ext <- c(-71.8101, 42.1193, -71.8041, 42.1242)
out1 <- substr(basename(planet_imgs_udm[[img_index]]), 1, 1000)
prj <- proj4string(b1_udm)
planet1_udm <- img_align(img = b1_udm@file@name, res = 3 / 100000, out_dir = out_dir, 
                     out_name = out1, ext = ext)
plot(planet1_udm[[c(1)]], scale = 1, zlim = c(0, 1), stretch = "lin") ## band 1 is clearness index


## recreate the false-color composite of the same date (July 05)
## for some reason you need to rerun the code below... you can't just 
## skip to the plotRGB command

b1 <- brick(planet_imgs[[img_index]])

# Use gdal to reproject images to EPSG4326 and to a defined extent
ext <- c(-71.8101, 42.1193, -71.8041, 42.1242)
out1 <- substr(basename(planet_imgs[[img_index]]), 1, 1000)
prj <- proj4string(b1)
planet1 <- img_align(img = b1@file@name, res = 3 / 100000, out_dir = out_dir, 
                     out_name = out1, ext = ext)
plotRGB(planet1[[c(4, 3, 2)]], scale = 10000, zlim = c(0,10000), stretch = "lin")
```


Cell Stats, clearness index
```{r, eval=FALSE}

## get percent of pixels in image that are clear
pct_clear_table <- freq(planet1_udm[[c(1)]], digits=0, value=NULL, useNA='ifany', progress='')
pct_clear_table

pct_clear <- as.numeric(pct_clear_table[2, "count"]) / sum(pct_clear_table[ , "count"])
pct_clear


```


Let's create a PDF that shows the false color composite and UDM
```{r, eval=FALSE}

pdf(paste0("Whittier_Planet_July_05.pdf"), onefile = T) ## start plotting to PDF

image_date <- substr(basename(planet1_udm@file@name), 1, 15) 

###plotting the UDM2 clearness band (band 1)
plot(planet1_udm[[c(1)]], scale = 1, zlim = c(0, 1), stretch = "lin", ## band 1 is clearness index
     main =  paste0(image_date, " clearness index ", round(pct_clear, 2)))

### plot false color composite of SR 
plotRGB(planet1[[c(4, 3, 2)]], scale = 10000, zlim = c(0,10000), stretch = "lin")

dev.off() ## end plotting to PDF


```


```{r, eval=FALSE}
pdf(paste0("Whittier_Planet_all.pdf"), onefile = T) ### open pdf

for (i in seq(length(planet_imgs))) {
## add code here
  print(i)
  ## for each i, process and plot the band 1 of the UDM2 mask and 
  ## the false color composite
  
}


dev.off() ### close pdf
```


### comparing sensors
### Let's compare NDVI time-series for different sensors
### Sensor data is in the "_metadata.json" file
```{r, eval=FALSE}



```
